#!/usr/bin/env bash
#
# principal - Automated codebase improvement using Claude Code
#
# Usage: principal [OPTIONS] [FOCUS_AREA]
#
# Options:
#   -n, --max-iters NUM     Maximum iterations (default: 5)
#   -s, --stall-limit NUM   Stop after N consecutive no-change rounds (default: 3)
#   -p, --prompt TEXT       Custom prompt (appended to base prompt)
#   -d, --dry-run           Show what would be done without executing
#   -v, --verbose           Verbose output
#   -h, --help              Show this help
#
# Examples:
#   principal                           # General improvements
#   principal "error handling"          # Focus on error handling
#   principal -n 10 "type safety"       # 10 iterations on type safety

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Defaults
MAX_ITERS=5
STALL_LIMIT=3
CUSTOM_PROMPT=""
DRY_RUN=false
VERBOSE=false
FOCUS_AREA=""

# Counters
total_changes=0
stall_count=0
start_time=$(date +%s)

usage() {
    sed -n '3,17p' "$0" | sed 's/^# //' | sed 's/^#//'
    exit 0
}

log()         { echo -e "${BLUE}[principal]${NC} $*"; }
log_success() { echo -e "${GREEN}✓${NC} $*"; }
log_warn()    { echo -e "${YELLOW}⚠${NC} $*"; }
log_error()   { echo -e "${RED}✗${NC} $*" >&2; }
log_iter()    { echo -e "${CYAN}━━━ $* ━━━${NC}"; }

cleanup() {
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    log "Session Summary"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    log "Total commits: ${total_changes}"
    log "Duration: $((duration / 60))m $((duration % 60))s"
    if [[ $total_changes -gt 0 ]]; then
        log "Recent changes:"
        git log --oneline -n "$total_changes" 2>/dev/null | sed 's/^/  /'
    fi
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

trap cleanup EXIT

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--max-iters)   MAX_ITERS="$2"; shift 2 ;;
        -s|--stall-limit) STALL_LIMIT="$2"; shift 2 ;;
        -p|--prompt)      CUSTOM_PROMPT="$2"; shift 2 ;;
        -d|--dry-run)     DRY_RUN=true; shift ;;
        -v|--verbose)     VERBOSE=true; shift ;;
        -h|--help)        usage ;;
        -*)               log_error "Unknown option: $1"; usage ;;
        *)                FOCUS_AREA="$1"; shift ;;
    esac
done

# Verify git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    log_error "Not in a git repository"
    exit 1
fi

# Build prompt
BASE_PROMPT="You are a principal engineer performing a focused code improvement session.

RULES:
- Make ONE focused, atomic improvement per iteration
- Priority: security > correctness > performance > maintainability
- Think deeply and systematically; trace causes/effects before changing code
- Show your reasoning in the code changes and verify logic instead of guessing
- Do NOT ask questions - make reasonable decisions
- Do NOT create new files unless absolutely necessary
- Prefer small changes over large refactors
- Skip purely cosmetic changes
- If no meaningful improvements remain, make no changes"

if [[ -n "$FOCUS_AREA" ]]; then
    BASE_PROMPT="${BASE_PROMPT}

FOCUS: ${FOCUS_AREA}
Concentrate on this specific area."
fi

if [[ -n "$CUSTOM_PROMPT" ]]; then
    BASE_PROMPT="${BASE_PROMPT}

CONTEXT: ${CUSTOM_PROMPT}"
fi

# Show config
log "Starting session"
log "  Max iterations: ${MAX_ITERS}"
log "  Stall limit: ${STALL_LIMIT}"
[[ -n "$FOCUS_AREA" ]] && log "  Focus: ${FOCUS_AREA}"
[[ "$DRY_RUN" == true ]] && log "  Mode: DRY RUN"
echo ""

if [[ "$DRY_RUN" == true ]]; then
    log "Prompt:"
    echo "$BASE_PROMPT" | sed 's/^/  /'
    exit 0
fi

# Main loop
for i in $(seq 1 "$MAX_ITERS"); do
    log_iter "Iteration $i/$MAX_ITERS"

    # Run Claude
    if ! claude --dangerously-skip-permissions -p "$BASE_PROMPT"; then
        log_warn "Claude exited non-zero, continuing..."
    fi

    git add -A

    if git diff --cached --quiet; then
        ((stall_count++))
        log_warn "No changes (stall: ${stall_count}/${STALL_LIMIT})"

        if [[ $stall_count -ge $STALL_LIMIT ]]; then
            log "Stopping: stalled for ${STALL_LIMIT} rounds"
            break
        fi
    else
        stall_count=0
        ((total_changes++))

        # Descriptive commit message
        changed_files=$(git diff --cached --name-only | head -3 | tr '\n' ' ')
        if [[ -n "$FOCUS_AREA" ]]; then
            commit_msg="chore(${FOCUS_AREA}): principal #${total_changes}"
        else
            commit_msg="chore: principal improvement #${total_changes}"
        fi

        git commit --no-verify -m "${commit_msg}

Files: ${changed_files}
Iteration: ${i}/${MAX_ITERS}"

        log_success "Committed: ${commit_msg}"

        if [[ "$VERBOSE" == true ]]; then
            git diff HEAD~1 --stat | sed 's/^/  /'
        fi
    fi

    echo ""
done

log_success "Complete"
